# 系统模式和架构

## 技术架构

### VSCode 扩展架构

```
VSCode Extension Host
├── Extension Entry Point (extension.ts)
├── Command Registration
├── Configuration Management
└── API Integration
```

### 核心组件

1. **命令处理器**: 处理 `extension.copyCodeBlock` 命令
2. **格式化引擎**: 处理令牌替换和格式化
3. **配置管理器**: 管理用户自定义格式
4. **剪贴板接口**: 与系统剪贴板交互

## 设计模式

### 1. 命令模式 (Command Pattern)

- **应用**: VSCode 命令注册和执行
- **优势**: 解耦命令调用和执行逻辑
- **实现**: `vscode.commands.registerCommand`

### 2. 策略模式 (Strategy Pattern)

- **应用**: 多种格式化策略
- **优势**: 支持运行时切换格式
- **实现**: 基于 `formatName` 选择不同格式配置

### 3. 模板方法模式 (Template Method Pattern)

- **应用**: 令牌替换系统
- **优势**: 统一的处理流程，灵活的变量替换
- **实现**: 字符串模板 + 令牌映射

## 数据流

### 当前数据流

```
用户触发命令 → 获取光标位置 → 读取当前行 → 应用格式模板 → 复制到剪贴板
```

### 目标数据流（添加选中内容支持）

```
用户触发命令 → 检测选中状态 → 获取选中内容或当前行 → 应用格式模板 → 复制到剪贴板
```

## 令牌系统架构

### 令牌分类

1. **静态令牌**: 文件路径、时间等固定值
2. **动态令牌**: 行号、代码内容等上下文相关值
3. **格式令牌**: EOL、分隔符等格式控制

### 令牌解析流程

```
模板字符串 → 令牌识别 → 值获取 → 字符串替换 → 最终输出
```

## 扩展点设计

### 新增 `${SELECTED_CODE}` 令牌

- **检测逻辑**: `vscode.window.activeTextEditor.selection`
- **获取方式**: `document.getText(selection)`
- **回退机制**: 无选中时回退到当前行内容

### 兼容性考虑

- 保持现有 `${CODE}` 令牌功能不变
- 新令牌作为可选功能添加
- 向后兼容现有配置

## 错误处理模式

### 异常场景

1. 无活动编辑器
2. 空文档
3. 无效选区
4. 格式配置错误

### 处理策略

- 优雅降级
- 用户友好的错误提示
- 日志记录

## 性能考虑

### 优化点

1. **延迟加载**: 配置按需加载
2. **缓存机制**: 重复令牌值缓存
3. **批量处理**: 多选区域统一处理

### 内存管理

- 及时释放大文本内容
- 避免循环引用
- 合理使用事件监听器

## 测试策略

### 单元测试

- 令牌解析功能
- 格式化逻辑
- 边界条件处理

### 集成测试

- VSCode API 集成
- 用户交互流程
- 配置加载验证

### 用户验收测试

- 实际使用场景验证
- 性能基准测试
- 兼容性测试
