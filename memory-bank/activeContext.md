# 活动上下文

## 当前开发焦点

### 主要目标

为 VSCode Copy Code Block 扩展添加新的令牌支持：

1. ✅ `${SELECTED_CODE}` 令牌 - 已完成
2. 🔄 `${MARKDOWN_HEADING}` 令牌 - 当前开发中

### 优先级排序

1. **P0 - 核心功能实现**: 添加 `${SELECTED_CODE}` 令牌
2. **P1 - 兼容性保证**: 确保现有功能不受影响
3. **P2 - 用户体验优化**: 改进多选区域处理
4. **P3 - 文档更新**: 更新 README 和配置说明

## 当前开发阶段

### 阶段 1: 需求分析和设计 ✅

- [x] 分析现有代码结构
- [x] 设计新令牌实现方案
- [x] 确定技术路径

### 阶段 2: 核心功能开发 🔄

- [ ] 实现选区检测逻辑
- [ ] 添加新令牌到处理系统
- [ ] 处理边界条件和错误情况
- [ ] 确保向后兼容性

### 阶段 3: 测试和验证 ⏳

- [ ] 编写单元测试
- [ ] 进行集成测试
- [ ] 用户场景验证
- [ ] 性能测试

### 阶段 4: 文档和发布 ⏳

- [ ] 更新 README 文档
- [ ] 更新 package.json 配置说明
- [ ] 准备发布说明
- [ ] 版本发布

## 技术决策

### 已确定的技术方案

1. **令牌实现**: 使用 `vscode.TextEditor.selection` API 检测选区
2. **回退机制**: 无选中时回退到当前行内容（保持 `${CODE}` 行为）
3. **多选支持**: 利用现有的多选配置选项
4. **兼容性**: 新令牌作为独立功能，不影响现有令牌

### 待决定的问题

1. **性能限制**: 是否需要对选中内容大小设置限制？
2. **扩展令牌**: 是否同时添加选区相关的其他令牌？
3. **配置选项**: 是否需要新的配置选项来控制新功能？

## 开发环境设置

### 必需工具

- Node.js (16.x)
- TypeScript (^4.9.5)
- VSCode Extension Development Host
- ESLint

### 开发流程

1. 修改源代码
2. 编译 TypeScript (`npm run compile`)
3. 在 Extension Development Host 中测试
4. 运行测试套件 (`npm test`)
5. 代码检查 (`npm run lint`)

## 当前工作项

### 立即执行

- [ ] 检查现有源代码结构
- [ ] 定位令牌处理逻辑
- [ ] 实现选区检测功能
- [ ] 添加新令牌到映射表

### 本周目标

- [ ] 完成核心功能开发
- [ ] 基本功能测试通过
- [ ] 兼容性验证完成

### 下周计划

- [ ] 完善测试覆盖
- [ ] 文档更新
- [ ] 准备发布

## 风险和缓解措施

### 技术风险

1. **API 兼容性**: VSCode API 变更风险
   - 缓解: 使用稳定的 API，添加版本检查
2. **性能影响**: 大文件选中可能影响性能
   - 缓解: 添加大小限制和异步处理
3. **用户配置**: 现有用户配置可能受影响
   - 缓解: 严格的向后兼容性测试

### 项目风险

1. **开发时间**: 功能复杂度可能超出预期
   - 缓解: 分阶段实现，优先核心功能
2. **测试覆盖**: 测试场景可能不够全面
   - 缓解: 制定详细的测试计划

## 成功标准

### 功能标准

- [x] 用户可以选中代码块并使用快捷键复制
- [ ] 新令牌 `${SELECTED_CODE}` 正确工作
- [ ] 无选中时回退到当前行行为
- [ ] 多选区域正确处理
- [ ] 现有功能保持不变

### 质量标准

- [ ] 代码覆盖率 > 80%
- [ ] 所有测试用例通过
- [ ] 无 ESLint 错误
- [ ] 性能无明显下降

### 用户体验标准

- [ ] 功能直观易用
- [ ] 错误处理友好
- [ ] 文档清晰完整
